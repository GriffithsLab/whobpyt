
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="auto">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The Role of Recurrent Network Feedback in TMS-EEG Evoked Responses &#8212; MNE  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "auto";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "auto";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/css/fix-sidebar.css?v=52f27943" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=1395d0ad" />
    <link rel="stylesheet" type="text/css" href="../_static/css/fix-sidebar.css?v=52f27943" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=7f41d439"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=fd10adb8"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-5TBCPCRB6X"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-5TBCPCRB6X');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-5TBCPCRB6X');
            </script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'auto_examples/eg__momi2023';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="canonical" href="https://mne.tools/stable/auto_examples/eg__momi2023.html" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="auto">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/whobpyt_logo_feet.png" class="logo__image only-light" alt="MNE  documentation - Home"/>
    <img src="../_static/whobpyt_logo_feet_dark.png" class="logo__image only-dark pst-js-only" alt="MNE  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/index.html">
    Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/science/index.html">
    Science
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/development/index.html">
    Contribute
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="External Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/griffithslab/whobpyt" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-fw fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/index.html">
    Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/science/index.html">
    Science
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../documentation/development/index.html">
    Contribute
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="External Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/griffithslab/whobpyt" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-fw fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none"></div>
              
              
<div>
  
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-eg-momi2023-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="the-role-of-recurrent-network-feedback-in-tms-eeg-evoked-responses">
<span id="ex-momi2023"></span><span id="sphx-glr-auto-examples-eg-momi2023-py"></span><h1>The Role of Recurrent Network Feedback in TMS-EEG Evoked Responses<a class="headerlink" href="#the-role-of-recurrent-network-feedback-in-tms-eeg-evoked-responses" title="Link to this heading">#</a></h1>
<p>This example gives a replication and didactic explanation of the TMS-EEG modelling
and results reported in Momi, Wang, &amp; Griffiths (ELife 2023).</p>
<p>The code includes data fetching, model fitting, and result visualization based on the methods presented in the paper.</p>
<p>Please read our <a class="reference external" href="https://elifesciences.org/articles/83232">paper</a>, and if you use this code, please cite it:</p>
<p>Momi, D., Wang, Z., Griffiths, J.D. (2023).
“TMS-evoked responses are driven by recurrent large-scale network dynamics.”
eLife, <a class="reference external" href="https://elifesciences.org/articles/83232">doi: 10.7554/eLife.83232</a>.</p>
<section id="overview-of-study-and-summary-of-key-results">
<h2>0. Overview of study and summary of key results<a class="headerlink" href="#overview-of-study-and-summary-of-key-results" title="Link to this heading">#</a></h2>
<p><em>(content modified from GriffithsLab/PyTepFit github repo, and the paper itself)</em></p>
<section id="study-overview">
<h3>Study Overview<a class="headerlink" href="#study-overview" title="Link to this heading">#</a></h3>
<p>Grand-mean structural connectome was calculated using neuroimaging data of
400 healthy young individuals (Males= 170; Age range 21-35 years old) from
the Human Connectome Project (HCP) Dataset.
The Schaefer Atlas of 200 parcels was used, which groups brain regions into
7 canonical functional networks (Visual: VISN, Somato-motor: SMN, Dorsal
Attention: DAN, Anterior Salience: ASN, Limbic: LIMN, Fronto-parietal:
FPN, Default Mode DMN). These parcels were mapped to the individual’s
FreeSurfer parcellation using spherical registration. Once this brain
parcellation covering cortical structures was extrapolated, it was then
used to extract individual structural connectomes. The Jansen-Rit model 22,
a physiological connectome-based neural mass model, was embedded in every
parcel for simulating time series. The TMS-induced polarization effect of
the resting membrane potential was modeled by perturbing voltage offset
uTMS to the mean membrane potential of the excitatory interneurons. A
lead-field matrix was then used for moving the parcels’ timeseries into
channel space and generating simulated TMS-EEG activity. The goodness-of-fit
(loss) was calculated as the spatial distance between simulated and empirical
TMS-EEG timeseries from an open dataset. The corresponding gradient was
computed using Automatic Differentiation. Model parameters were then updated
accordingly using the optimization algorithm (ADAM). The model was run with
new updated parameters, and the process was repeated until convergence
between simulated and empirical timeseries was found. At the end of iteration,
the optimal model parameters were used to generate the fitted simulated
TMS-EEG activity, which was compared with the empirical data at both the
channel and source level.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/momi2023__Figure_7.png"><img alt="Momi 2023 Fig. 7" src="../_images/momi2023__Figure_7.png" style="width: 600px;" />
</a>
</figure>
</section>
<section id="conceptual-framework">
<h3>Conceptual Framework<a class="headerlink" href="#conceptual-framework" title="Link to this heading">#</a></h3>
<p>Studying the role of recurrent connectivity in stimulation-evoked neural responses
with computational models. Shown here is a schematic overview of the hypotheses,
methodology, and general conceptual framework of the present work. A) Single
TMS stimulation (i [diagram], iv [real data]) pulse applied to a target region
(in this case left M1) generates an early response (TEP waveform component) at
EEG channels sensitive to that region and its immediate neighbours (ii). This also
appears in more distal connected regions such as the frontal lobe (iii) after a
short delay due to axonal conduction and polysynaptic transmission. Subsequently,
second and sometimes third late TEP components are frequently observed at the
target site (i, iv), but not in nonconnected regions (v). Our question is whether
these late responses represent evoked oscillatory ‘echoes’ of the initial
stimulation that are entirely ‘local’ and independent of the rest of the network,
or whether they rather reflect a chain of recurrent activations dispersing from
and then propagating back to the initial target site via the connectome. B) In
order to investigate this, precisely timed communication interruptions or
‘virtual lesions’ (vii) are introduced into an otherwise accurate and well-fitting
computational model of TMS-EEG stimulation responses (vi). and the resulting
changes in the propagation pattern (viii) were evaluated. No change in the TEP
component of interest would support the ‘local echo’ scenario, and whereas
suppressed TEPs would support the ‘recurrent activation’ scenario.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/momi2023__Figure_2.PNG"><img alt="Momi 2023 Fig. 2" src="../_images/momi2023__Figure_2.PNG" style="width: 600px;" />
</a>
</figure>
</section>
<section id="large-scale-neurophysiological-brain-network-model">
<h3>Large-scale neurophysiological brain network model<a class="headerlink" href="#large-scale-neurophysiological-brain-network-model" title="Link to this heading">#</a></h3>
<p>A brain network model comprising 200 cortical areas was used to model TMS-evoked activity
patterns, where each network node represents population-averaged activity of a single brain
region according to the rationale of mean field theory60. We used the Jansen-Rit (JR)
equations to describe activity at each node, which is one of the most widely used
neurophysiological models for both stimulus-evoked and resting-state EEG activity
measurements. JR is a relatively coarse-grained neural mass model of the cortical
microcircuit, composed of three interconnected neural populations: pyramidal projection
neurons, excitatory interneurons, and inhibitory interneurons. The excitatory and the
inhibitory populations both receive input from and feed back to the pyramidal population
but not to each other, and so the overall circuit motif contains one positive and one
negative feedback loop. For each of the three neural populations, the post-synaptic
somatic and dendritic membrane response to an incoming pulse of action potentials is
described by the second-order differential equation:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?%5CDdot%7Bv%7D%5Cleft%28t%5Cright%29%20&amp;plus;%5Cfrac%7B2%7D%7B%5Ctau_%7Be%2Ci%7D%7D%5Cdot%7Bv%7D%5Cleft%28t%5Cright%29&amp;plus;%5Cfrac%7B1%7D%7B%5Ctau_%7Be.i%7D%5E2%7Dv%5Cleft%28t%5Cright%29%20%3D%20%5Cfrac%7BH_%7Be%2Ci%7D%7D%7B%5Ctau_%7Be%2Ci%7D%7Dm%5Cleft%28t%5Cright%29&gt;"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?%5CDdot%7Bv%7D%5Cleft%28t%5Cright%29%20&amp;plus;%5Cfrac%7B2%7D%7B%5Ctau_%7Be%2Ci%7D%7D%5Cdot%7Bv%7D%5Cleft%28t%5Cright%29&amp;plus;%5Cfrac%7B1%7D%7B%5Ctau_%7Be.i%7D%5E2%7Dv%5Cleft%28t%5Cright%29%20%3D%20%5Cfrac%7BH_%7Be%2Ci%7D%7D%7B%5Ctau_%7Be%2Ci%7D%7Dm%5Cleft%28t%5Cright%29&gt;" style="width: 300px;" />
</a>
</figure>
<p>which is equivalent to a convolution of incoming activity with a synaptic impulse response function</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?v%28t%29%20%3D%20%5Cint%5Climits_0%5E%7B%5Cinfty%7D%20d%20%5Ctau%20m%28%5Ctau%29%20%5Ccdot%20h_%7Be%2Ci%7D%20%28t-%5Ctau%29"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?v%28t%29%20%3D%20%5Cint%5Climits_0%5E%7B%5Cinfty%7D%20d%20%5Ctau%20m%28%5Ctau%29%20%5Ccdot%20h_%7Be%2Ci%7D%20%28t-%5Ctau%29" style="width: 300px;" />
</a>
</figure>
<p>whose kernel <span class="math notranslate nohighlight">\(h_{e,i}(t)\)</span> is given by</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?h_%7Be%2Ci%7D%20%3D%20%5Cfrac%7BH_%7Be%2Ci%7D%7D%7B%5Ctau_%7Be%2Ci%7D%7D%20%5Ccdot%20t%20%5Ccdot%20exp%28%20-%5Cfrac%7Bt%7D%7B%5Ctau_%7Be%2Ci%7D%7D%20%29"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?h_%7Be%2Ci%7D%20%3D%20%5Cfrac%7BH_%7Be%2Ci%7D%7D%7B%5Ctau_%7Be%2Ci%7D%7D%20%5Ccdot%20t%20%5Ccdot%20exp%28%20-%5Cfrac%7Bt%7D%7B%5Ctau_%7Be%2Ci%7D%7D%20%29" style="width: 300px;" />
</a>
</figure>
<p>where <span class="math notranslate nohighlight">\(m(t)\)</span> is the (population-average) presynaptic input, <span class="math notranslate nohighlight">\(v(t)\)</span> is the postsynaptic membrane
potential, <span class="math notranslate nohighlight">\(H_{e,i}\)</span> is the maximum postsynaptic potential and <span class="math notranslate nohighlight">\(\tau_{e,i}\)</span>
lumped representation of delays occurring during the synaptic transmission.</p>
<p>This synaptic response function, also known as a pulse-to-wave operator <a class="reference external" href="https://www.sciencedirect.com/book/9780122671500/mass-action-in-the-nervous-system">(Freeman et al., 1975)</a>), determines the excitability of the population, as parameterized by the rate constants $a$ and $b$, which are of particular interest in the present study. Complementing the pulse-to-wave operator for the synaptic response, each neural population also has wave-to-pulse operator [Freeman et al., 1975](<a class="reference external" href="https://www.sciencedirect.com/book/9780122671500/mass-action-in-the-nervous-system">https://www.sciencedirect.com/book/9780122671500/mass-action-in-the-nervous-system</a>) that determines the its output - the (population-average) firing rate - which is an instantaneous function of the somatic membrane potential that takes the sigmoidal form</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?Su%28t%29%20%3D%20%5Cbegin%7Bcases%7D%20%5Cfrac%7Be_%7B0%7D%7D%7B1-exp%28r%28v_%7B0%7D%20-%20v%28t%29%29%29%7D%20%26%20t%5Cgeq%200%20%5C%5C%200%20%26%20t%5Cleq%200%20%5C%5C%20%5Cend%7Bcases%7D"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?Su%28t%29%20%3D%20%5Cbegin%7Bcases%7D%20%5Cfrac%7Be_%7B0%7D%7D%7B1-exp%28r%28v_%7B0%7D%20-%20v%28t%29%29%29%7D%20%26%20t%5Cgeq%200%20%5C%5C%200%20%26%20t%5Cleq%200%20%5C%5C%20%5Cend%7Bcases%7D" style="width: 300px;" />
</a>
</figure>
<p>where <span class="math notranslate nohighlight">\(e_{0}\)</span> is the maximum pulse, <span class="math notranslate nohighlight">\(r\)</span> is the steepness of the sigmoid function, and <span class="math notranslate nohighlight">\(v_0\)</span> is the postsynaptic potential for which half of the maximum pulse rate is achieved.</p>
<p>In practice, we re-write the three sets of second-order differential equations that follow the form in (1) as pairs of coupled first-order differential equations, and so the full JR system for each individual cortical area <span class="math notranslate nohighlight">\(j \in i:N\)</span> in our network of <span class="math notranslate nohighlight">\(N=200\)</span> regions is given by the following six equations:</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?%5Cdot%7Bv%7D_%7Bj1%7D%20%3D%20x_%7Bj1%7D"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?%5Cdot%7Bv%7D_%7Bj1%7D%20%3D%20x_%7Bj1%7D" style="width: 100px;" />
</a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?%5Cdot%7Bx%7D_%7Bj1%7D%20%3D%20%5Cfrac%7BH_e%7D%7B%5Ctau_e%7D%5Cleft%28p%28t%29&amp;plus;%5Cmathrm%7Bconn%7D_j&amp;plus;S%28v_%7Bj2%7D%29%5Cright%29%20-%20%5Cfrac%7B2%7D%7B%5Ctau_e%7Dx_%7Bj1%7D%20-%20%5Cfrac%7B1%7D%7B%5Ctau_e%5E2%7Dv_%7Bj1%7D"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?%5Cdot%7Bx%7D_%7Bj1%7D%20%3D%20%5Cfrac%7BH_e%7D%7B%5Ctau_e%7D%5Cleft%28p%28t%29&amp;plus;%5Cmathrm%7Bconn%7D_j&amp;plus;S%28v_%7Bj2%7D%29%5Cright%29%20-%20%5Cfrac%7B2%7D%7B%5Ctau_e%7Dx_%7Bj1%7D%20-%20%5Cfrac%7B1%7D%7B%5Ctau_e%5E2%7Dv_%7Bj1%7D" style="width: 300px;" />
</a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?%5Cdot%7Bv%7D_%7Bj2%7D%20%3D%20x_%7Bj2%7D"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?%5Cdot%7Bv%7D_%7Bj2%7D%20%3D%20x_%7Bj2%7D" style="width: 100px;" />
</a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?%5Cdot%7Bx%7D_%7Bj2%7D%20%3D%20%5Cfrac%7BH_i%7D%7B%5Ctau_i%7D%5Cleft%28S%28v_%7B3j%7D%29%5Cright%29%20-%20%5Cfrac%7B2%7D%7B%5Ctau_i%7Dx_%7Bj2%7D%20-%20%5Cfrac%7B1%7D%7B%5Ctau_i%5E2%7Dv_%7Bj2%7D"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?%5Cdot%7Bx%7D_%7Bj2%7D%20%3D%20%5Cfrac%7BH_i%7D%7B%5Ctau_i%7D%5Cleft%28S%28v_%7B3j%7D%29%5Cright%29%20-%20%5Cfrac%7B2%7D%7B%5Ctau_i%7Dx_%7Bj2%7D%20-%20%5Cfrac%7B1%7D%7B%5Ctau_i%5E2%7Dv_%7Bj2%7D" style="width: 300px;" />
</a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?%5Cdot%7Bv%7D_%7Bj3%7D%20%3D%20x_%7Bj3%7D"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?%5Cdot%7Bv%7D_%7Bj3%7D%20%3D%20x_%7Bj3%7D" style="width: 100px;" />
</a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="https://latex.codecogs.com/png.latex?%5Cdot%7Bx%7D_%7Bj3%7D%20%3D%20%5Cfrac%7BH_e%7D%7B%5Ctau_e%7D%5Cleft%28S%28v_%7Bj1%7D%20-%20v_%7Bj2%7D%29%5Cright%29%20-%20%5Cfrac%7B2%7D%7B%5Ctau_e%7Dx_%7Bj3%7D%20-%20%5Cfrac%7B1%7D%7B%5Ctau_e%5E2%7Dv_%7Bj3%7D"><img alt="Momi 2023 Eqn." src="https://latex.codecogs.com/png.latex?%5Cdot%7Bx%7D_%7Bj3%7D%20%3D%20%5Cfrac%7BH_e%7D%7B%5Ctau_e%7D%5Cleft%28S%28v_%7Bj1%7D%20-%20v_%7Bj2%7D%29%5Cright%29%20-%20%5Cfrac%7B2%7D%7B%5Ctau_e%7Dx_%7Bj3%7D%20-%20%5Cfrac%7B1%7D%7B%5Ctau_e%5E2%7Dv_%7Bj3%7D" style="width: 300px;" />
</a>
</figure>
<p>where <span class="math notranslate nohighlight">\(v_{1,2,3}\)</span> is the average postsynaptic membrane potential of populations of the excitatory stellate cells, inhibitory interneuron, and excitatory pyramidal cell populations, respectively.
The output <span class="math notranslate nohighlight">\(y(t) = v_1(t) - v_2(t)\)</span> is the EEG signal.</p>
</section>
<section id="data">
<h3>Data<a class="headerlink" href="#data" title="Link to this heading">#</a></h3>
<p>For the purposes of this study, already preprocessed TMS-EEG data following a stimulation of primary motor cortex (M1) of twenty healthy young individuals (24.50 ± 4.86 years; 14 females) were taken from an open dataset (<a class="reference external" href="https://figshare.com/articles/dataset/TEPs-_SEPs/7440713">https://figshare.com/articles/dataset/TEPs-_SEPs/7440713</a>). For details regarding on the data acquisition and the preprocessing steps please refer to the original paper</p>
<ul class="simple">
<li><p>Biabani M, Fornito A, Coxon JP, Fulcher BD &amp; Rogasch NC (2021). The correspondence between EMG and EEG measures of changes in cortical excitability following transcranial magnetic stimulation. J Physiol 599, 2907–2932.</p></li>
<li><p>Biabani M, Fornito A, Mutanen TP, Morrow J &amp; Rogasch NC (2019). Characterizing and minimizing the contribution of sensory inputs to TMS-evoked potentials. Brain Stimulat 12, 1537–1552.</p></li>
</ul>
</section>
<section id="main-results">
<h3>Main Results<a class="headerlink" href="#main-results" title="Link to this heading">#</a></h3>
<p>Comparison between simulated and empirical TMS-EEG data in channel space.
A) Empirical and simulated TMSEEG time series for 3 representative subjects showing a robust recovery of individual subjects’ empirical TEP propagation patterns in model-generated activity EEG time series. B) Pearson correlation coefficients over subjects between empirical and simulated TMS-EEG time series. C) Time-wise permutation tests results showing the significant Pearson correlation coefficient and the corresponding reversed p-values (bottom) for every electrode. D) PCI values extracted from the empirical (orange) and simulated (blue) TMS-EEG time series (left). Significant positive correlation (R2 = 80%, p &lt; 0.0001) was found between the simulated and the empirical PCI (right).</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/GriffithsLab/PyTepFit/main/img/Figure_3.PNG"><img alt="Momi 2023 Eqn." src="https://raw.githubusercontent.com/GriffithsLab/PyTepFit/main/img/Figure_3.PNG" style="width: 600px;" />
</a>
</figure>
<p>Comparison between simulated and empirical TMS-EEG data in source space. A) TMS-EEG time series showing a robust recovery of grand-mean empirical TEP patterns in model-generated EEG time series. B) Source reconstructed TMS-evoked propagation pattern dynamics for empirical (top) and simulated (bottom) data. C) Time-wise permutation test results showing the significant Pearson correlation coefficient (tp) and the corresponding reversed p-values (bottom) for every vertex. Network-based dSPM values extracted for the grand mean empirical (left) and simulated (right) source-reconstructed time series.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/GriffithsLab/PyTepFit/main/img/Figure_4.PNG"><img alt="Momi 2023 Eqn." src="https://raw.githubusercontent.com/GriffithsLab/PyTepFit/main/img/Figure_4.PNG" style="width: 600px;" />
</a>
</figure>
<p>Synaptic time constant of inhibitory population affects early and late TEP amplitudes.
A) Singular value decomposition (SVD) topoplots for simulated (top) and empirical (bottom)
TMS-EEG data. By looking at simulated (top) and empirical (bottom) grand mean timeseries,
results revealed that the first (orange outline) and the second (blue outline) components
were located ∼65ms and ∼110ms after the TMS pulse. B) First (orange outline) and second
(blue outline) components latency and amplitude were extracted for every subject and the
distribution plots (top row) show the time location where higher cosine similarity with
the SVD components were found. Scatter plots (bottom row) show a negative (left) and
positive (right) significant correlation between the synaptic time constant of the
inhibitory population and the amplitude of the the first and second component. C) Model-
generated first and second SVD components for 2 representative subjects with high (top)
and low (bottom) value for the synaptic time constant of the inhibitory population.
Topoplots show that higher synaptic time constant affects the amplitude of the individual
first and second SVD components. D) Model-generated TMS-EEG data were run using the optimal
(top right) or a value decreased by 85% (central left) for the synaptic time constant of
the inhibitory population. Absolute values for different values of the synaptic time
constant of the inhibitory population (bottom right). Results show an increase in the
amplitude of the early first local component and a decrease of the second latest global
component</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/GriffithsLab/PyTepFit/main/img/Figure_6.PNG"><img alt="Momi 2023 Eqn." src="https://raw.githubusercontent.com/GriffithsLab/PyTepFit/main/img/Figure_6.PNG" style="width: 600px;" />
</a>
</figure>
</section>
<section id="list-of-analyses-and-figures">
<h3>List of analyses and figures<a class="headerlink" href="#list-of-analyses-and-figures" title="Link to this heading">#</a></h3>
<p>The following code replicates key figures from the paper
“TMS-evoked responses are driven by recurrent large-scale network dynamics”.
The core finding of the paper is that early TEP components (&lt;100 ms) arise
from local reverberatory activity in the stimulated region,
while later components (&gt;100 ms) are driven by large-scale recurrent
network activity propagating across cortical and subcortical areas.</p>
<dl class="simple">
<dt>The replicated plots include scalp topographies and time series analyses</dt><dd><p>highlighting TEP dynamics, extracted peaks, and modeled network responses,
with code provided for EEG signal extraction, peak localization, and computational modeling.</p>
</dd>
</dl>
<p><strong>Replicated Figures and Code Sections</strong>
The following figures from the paper are replicated in the provided Jupyter Notebook:</p>
<dl class="simple">
<dt><strong>Appendix 2 — Figure 3</strong></dt><dd><ul class="simple">
<li><p>Code Section: 3.1</p></li>
</ul>
</dd>
<dt><strong>Appendix 2 — Figure 5 (Panel A)</strong></dt><dd><ul class="simple">
<li><p>Code Section: 3.3</p></li>
</ul>
</dd>
<dt><strong>Appendix 2 — Figure 10</strong></dt><dd><ul class="simple">
<li><p>Code Section: 3.4</p></li>
</ul>
</dd>
<dt><strong>Appendix 3- Figure 1</strong></dt><dd><ul class="simple">
<li><p>Code Section: 4.1</p></li>
</ul>
</dd>
<dt><strong>Figure 3 (Panel E)</strong></dt><dd><ul class="simple">
<li><p>Code Section: 4.2</p></li>
</ul>
</dd>
<dt><strong>Figure 2 (Panel D)</strong></dt><dd><ul class="simple">
<li><p>Code Section: 4.3</p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="setup">
<h2>1. Setup<a class="headerlink" href="#setup" title="Link to this heading">#</a></h2>
<p>Importage:</p>
<p>os stuff</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">whobpyt.depr.momi2023.jansen_rit</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParamsJR</span><span class="p">,</span> <span class="n">Model_fitting</span><span class="p">,</span> <span class="n">RNNJANSEN</span><span class="p">,</span> <span class="n">Costs</span><span class="p">,</span> <span class="n">OutputNM</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">whobpyt.depr.momi2023.pci</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_PCIst</span><span class="p">,</span> <span class="n">dimensionality_reduction</span><span class="p">,</span> <span class="n">calc_snr</span><span class="p">,</span> <span class="n">get_svd</span><span class="p">,</span> <span class="n">apply_svd</span><span class="p">,</span> <span class="n">state_transition_quantification</span><span class="p">,</span>\
    <span class="n">recurrence_matrix</span><span class="p">,</span> <span class="n">distance2transition</span><span class="p">,</span> <span class="n">distance2recurrence</span><span class="p">,</span> <span class="n">diff_matrix</span><span class="p">,</span> <span class="n">calc_maxdim</span><span class="p">,</span> <span class="n">dimension_embedding</span><span class="p">,</span>\
    <span class="n">preprocess_signal</span><span class="p">,</span> <span class="n">avgreference</span><span class="p">,</span> <span class="n">undersample_signal</span><span class="p">,</span> <span class="n">baseline_correct</span><span class="p">,</span> <span class="n">get_time_index</span><span class="p">,</span> <span class="n">bar_plot</span><span class="p">,</span> \
    <span class="n">spider_plot</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">whobpyt.depr.momi2023.pci</span><span class="w"> </span><span class="kn">import</span> <span class="n">bar_plot</span> <span class="k">as</span> <span class="n">bp_1</span>

<span class="c1"># viz stuff</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># python stuff</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdown</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1">#neuroimaging packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mne</span>

<span class="c1"># viz stuff</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>




<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sklearn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mne</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">whobpyt.datasets.fetchers</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_egmomi2023</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-pytb notranslate"><div class="highlight"><pre><span></span><span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;/home/runner/work/whobpyt/whobpyt/examples/eg__momi2023.py&quot;</span>, line <span class="m">263</span>, in <span class="n">&lt;module&gt;</span>
<span class="w">    </span><span class="kn">from</span><span class="w"> </span><span class="nn">whobpyt.depr.momi2023.jansen_rit</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParamsJR</span><span class="p">,</span> <span class="n">Model_fitting</span><span class="p">,</span> <span class="n">RNNJANSEN</span><span class="p">,</span> <span class="n">Costs</span><span class="p">,</span> <span class="n">OutputNM</span>
  File <span class="nb">&quot;/opt/hostedtoolcache/Python/3.9.22/x64/lib/python3.9/site-packages/whobpyt/__init__.py&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="w">    </span><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="gr">ImportError</span>: <span class="n">cannot import name &#39;models&#39; from partially initialized module &#39;whobpyt&#39; (most likely due to a circular import) (/opt/hostedtoolcache/Python/3.9.22/x64/lib/python3.9/site-packages/whobpyt/__init__.py)</span>
</pre></div>
</div>
<p>Download data</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">files_dir</span> <span class="o">=</span> <span class="n">fetch_egmomi2023</span><span class="p">()</span>
<span class="n">sc_file</span> <span class="o">=</span> <span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/Schaefer2018_200Parcels_7Networks_count.csv&#39;</span>
<span class="n">high_file</span> <span class="o">=</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/only_high_trial.mat&#39;</span>
<span class="n">dist_file</span> <span class="o">=</span> <span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/Schaefer2018_200Parcels_7Networks_distance.csv&#39;</span>
<span class="n">file_eeg</span> <span class="o">=</span> <span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/label_ts_corrected&#39;</span>
<span class="n">file_leadfield</span> <span class="o">=</span> <span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/leadfield&#39;</span>
<span class="n">file_eeg</span> <span class="o">=</span> <span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/real_EEG&#39;</span>
<span class="n">eeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_eeg</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">download_data = True</span>
<span class="sd">url = &#39;https://drive.google.com/drive/folders/1lrju2UiK3_amcNLb5G9gwJmdU_eO0wsi?usp=drive_link&#39;</span>

<span class="sd">if download_data: gdown.download_folder(url, quiet=True,  remaining_ok=True, use_cookies=False)</span>
<span class="sd">files_dir = os.path.abspath(&#39;data_website&#39;)</span>


<span class="sd">lf_dir = os.path.abspath(&#39;data_website/leadfield_from_mne&#39;)</span>

<span class="sd">sc_file = files_dir + &#39;/Schaefer2018_200Parcels_7Networks_count.csv&#39;</span>
<span class="sd">high_file =files_dir + &#39;/only_high_trial.mat&#39;</span>
<span class="sd">dist_file = files_dir + &#39;/Schaefer2018_200Parcels_7Networks_distance.csv&#39;</span>
<span class="sd">file_eeg = files_dir + &#39;/label_ts_corrected&#39;</span>
<span class="sd">file_leadfield = files_dir + &#39;/leadfield&#39;</span>
<span class="sd">file_eeg = files_dir + &#39;/real_EEG&#39;</span>
<span class="sd">eeg =np.load(file_eeg, allow_pickle=True)</span>
<span class="sd">eeg</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="model-fitting-and-key-results">
<h2>2 - Model fitting and key results<a class="headerlink" href="#model-fitting-and-key-results" title="Link to this heading">#</a></h2>
<section id="load-the-data">
<h3>2.1 Load the data<a class="headerlink" href="#load-the-data" title="Link to this heading">#</a></h3>
<p>leadfield file</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">lm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_leadfield</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">lm</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

<span class="c1"># TEP data</span>
<span class="n">data_high</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">high_file</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_high</span><span class="p">[</span><span class="s1">&#39;only_high_trial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plotting-example-trials-and-stimulated-data">
<h3>2.2 Plotting Example Trials and Stimulated Data<a class="headerlink" href="#plotting-example-trials-and-stimulated-data" title="Link to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">pck_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/*_fittingresults_stim_exp.pkl&#39;</span><span class="p">))</span>
<span class="n">pck_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">var</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^0-9]|[0-9]+&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">)])</span>

<span class="k">for</span> <span class="n">sbj2plot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing Subject </span><span class="si">{</span><span class="n">sbj2plot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Load EEG epochs</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

    <span class="c1"># Extract empirical data for the current subject</span>
    <span class="n">empirical_data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
    <span class="n">empirical_data</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj2plot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="c1"># Identify key EEG peak times</span>
    <span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>

    <span class="c1"># Define time points for joint plot</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>

    <span class="c1"># Plot empirical TEPs for the current subject</span>
    <span class="n">empirical_data</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Empirical TEPs for Subject </span><span class="si">{</span><span class="n">sbj2plot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Load simulated data from pickle file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sbj2plot</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Replace EEG data with simulated data for the subject</span>
    <span class="n">simulated_data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
    <span class="n">simulated_data</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span>

    <span class="c1"># Plot simulated TEPs for the current subject</span>
    <span class="n">simulated_data</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Simulated TEPs for Subject </span><span class="si">{</span><span class="n">sbj2plot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>



<span class="n">sbj2plot</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>

<span class="n">sbj2plot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbj2plot</span><span class="p">)</span>


<span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

<span class="n">empirical_data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
<span class="n">empirical_data</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj2plot</span><span class="p">,:,:]</span>

<span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.3</span><span class="p">])</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c1">#ch, peak_locs3 = evoked.get_peak(ch_type=&#39;eeg&#39;, tmin=0.1, tmax=0.12)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>

<span class="n">empirical_data</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Empirical TEPs for sub&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sbj2plot</span><span class="p">)</span> <span class="p">);</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sbj2plot</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">simulated_data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
<span class="n">simulated_data</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span><span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span>

<span class="n">simulated_data</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Simulated TEPs for sub&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sbj2plot</span><span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
<p><strong>Results Description:</strong>
Simulated TMS-evoked potentials (TEPs) for subject only_high_trial[0]
This plot simulates the TMS-evoked potentials (TEPs), typically observed in EEG studies combining Transcranial Magnetic Stimulation (TMS) and EEG to investigate cortical excitability and connectivity. Each peak or feature in the EEG signal corresponds to specific neural processes triggered by TMS.</p>
</section>
<section id="visualize-structural-connectivity-and-stimulation-weights">
<h3>2.3 Visualize Structural Connectivity and Stimulation Weights<a class="headerlink" href="#visualize-structural-connectivity-and-stimulation-weights" title="Link to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sc_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">sc_df</span><span class="o">.</span><span class="n">values</span>
<span class="n">dist_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dist_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">dist_df</span><span class="o">.</span><span class="n">values</span>

<span class="n">sc</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sc</span><span class="o">+</span><span class="n">sc</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>

<span class="n">stim_weights_file</span> <span class="o">=</span> <span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/stim_weights.npy&#39;</span>
<span class="n">stim_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stim_weights_file</span><span class="p">)</span>

<span class="n">ki0</span> <span class="o">=</span><span class="n">stim_weights</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="c1"># plt.plot(ki0)</span>
</pre></div>
</div>
</section>
<section id="model-setup-and-training">
<h3>2.4 Model Setup and Training<a class="headerlink" href="#model-setup-and-training" title="Link to this heading">#</a></h3>
<p>Run a shorter version with num_epochs = 2 to check the process without overwriting the results of the full run.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">node_size</span> <span class="o">=</span> <span class="n">stim_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">output_size</span> <span class="o">=</span> <span class="mi">62</span> <span class="c1">##gm.shape[0]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">step_size</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">input_size</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_epoches</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">tr</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">state_size</span> <span class="o">=</span><span class="mi">6</span>
<span class="n">base_batch_num</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">lm_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">output_size</span><span class="p">,</span><span class="n">node_size</span><span class="p">))</span>

<span class="c1">#[&#39;gm&#39;]:#[0, 1,2,3,5,6,7,8,9,10, 12,13,14,15,16,17,18]:#</span>
<span class="c1">#for i in range(data_high[&#39;only_high_trial&#39;].shape[0]):</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sub: &#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">data_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_high</span><span class="p">[</span><span class="s1">&#39;only_high_trial&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">num_epoches</span>
    <span class="c1">#data_mean = [gm]*num_epoches</span>
    <span class="n">data_mean</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_mean</span><span class="p">)</span>
    <span class="c1">#file_leadfield = lf_dir+f&#39;/sub{str(i+1).zfill(3)}/leadfield.npy&#39;</span>
    <span class="n">sub_file_leadfield</span> <span class="o">=</span> <span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/sub_</span><span class="si">%s</span><span class="s1">_leadfield&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading leadfield file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">sub_file_leadfield</span><span class="p">)</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sub_file_leadfield</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">par</span> <span class="o">=</span> <span class="n">ParamsJR</span><span class="p">(</span><span class="s1">&#39;JR&#39;</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">B</span> <span class="o">=</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">.1</span><span class="p">],</span> \
                    <span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">135</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">c2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">135</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="n">c3</span> <span class="o">=</span> <span class="p">[</span><span class="mi">135</span><span class="o">*</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="n">c4</span> <span class="o">=</span> <span class="p">[</span><span class="mi">135</span><span class="o">*</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>\
                    <span class="n">std_in</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">v0</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="p">[</span><span class="mf">0.56</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y0</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">output_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">output_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))],</span>\
                    <span class="n">mu</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span> <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">.3</span><span class="p">],</span> <span class="n">cy0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ki</span><span class="o">=</span><span class="p">[</span><span class="n">ki0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lm</span><span class="o">=</span><span class="p">[</span><span class="n">lm</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">output_size</span><span class="p">,</span> <span class="n">node_size</span><span class="p">))</span><span class="o">+</span><span class="n">lm_v</span><span class="p">]</span>
                   <span class="p">,</span><span class="n">w_bb</span><span class="o">=</span><span class="p">[</span><span class="n">sc</span><span class="p">,</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">node_size</span><span class="p">,</span> <span class="n">node_size</span><span class="p">))])</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">RNNJANSEN</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">node_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;call model fitting&#39;</span><span class="p">)</span>
    <span class="c1"># call model fit method</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">Model_fitting</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_mean</span><span class="p">[:,:,</span><span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">],</span> <span class="n">num_epoches</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># fit data(train)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">node_size</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">400</span><span class="p">))</span>
    <span class="n">u</span><span class="p">[:,:,</span><span class="mi">110</span><span class="p">:</span><span class="mi">120</span><span class="p">]</span><span class="o">=</span> <span class="mi">1000</span>
    <span class="n">output_train</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">node_size</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">400</span><span class="p">))</span>
    <span class="n">u</span><span class="p">[:,:,</span><span class="mi">110</span><span class="p">:</span><span class="mi">120</span><span class="p">]</span><span class="o">=</span> <span class="mi">1000</span>
    <span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">node_size</span><span class="p">,</span> <span class="n">state_size</span><span class="p">))</span>
    <span class="n">hE0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">node_size</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>

    <span class="n">output_test</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="n">hE0</span><span class="p">,</span> <span class="n">base_batch_num</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>

    <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


    <span class="n">sc_mod</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">sc_mod</span><span class="o">+</span><span class="n">sc_mod</span><span class="o">.</span><span class="n">T</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">sc_mod</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;filename = &#39;/content/drive/MyDrive/EEG/reproduce_fig/sub_&#39;+str(i)+&#39;_fittingresults_stim_exp.pkl&#39;</span>
<span class="sd">    with open(filename, &#39;wb&#39;) as f:</span>
<span class="sd">        pickle.dump(F, f)</span>

<span class="sd">    outfilename = &#39;/content/drive/MyDrive/EEG/reproduce_fig/sub_&#39;+str(i)+&#39;_simEEG_stim_exp.pkl&#39;</span>


<span class="sd">    with open(outfilename, &#39;wb&#39;) as f:</span>
<span class="sd">        pickle.dump(F.output_sim, f)&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">F</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">E_test</span><span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">I_test</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Test: sourced EEG&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_high</span><span class="p">[</span><span class="s1">&#39;only_high_trial&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">,:])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;empirical&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">end_time</span> <span class="o">=</span>  <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running time is  </span><span class="si">{0}</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="p">))</span>
</pre></div>
</div>
<p>check the output of output_sim.eeg_test</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># files_dir =  &#39;/external/rprshnas01/netdata_kcni/jglab/Data/Davide/reproduce_Momi_et_al_2022/PyTepFit/data&#39;</span>
<span class="n">pck_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/*_fittingresults_stim_exp.pkl&#39;</span><span class="p">))</span>
<span class="n">pck_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">var</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^0-9]|[0-9]+&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">)])</span>

<span class="n">sbj</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sbj</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="exploring-model-parameters">
<h2>3 - Exploring model parameters<a class="headerlink" href="#exploring-model-parameters" title="Link to this heading">#</a></h2>
<p>%%
3.1 Load and Sort Simulation Result Files
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">pck_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/*_fittingresults_stim_exp.pkl&#39;</span><span class="p">))</span>
<span class="n">pck_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">var</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^0-9]|[0-9]+&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">)])</span>
</pre></div>
</div>
<p>Extract Simulation Data Keys</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">keys</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>Initialize Data Storage Arrays
Create arrays to store different types of simulation data based on their dimensions.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;output_name&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
    <span class="n">variable_name</span> <span class="o">=</span> <span class="s1">&#39;all_&#39;</span> <span class="o">+</span> <span class="n">k</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;E_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;E_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Ev_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;Ev_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;I_train&#39;</span>
        <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;I_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Iv_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Iv_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;P_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;P_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Pv_train&#39;</span>
        <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Pv_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;EEG_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;EEG_test&#39;</span><span class="p">):</span>

        <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot; =  np.zeros((len(pck_files), getattr(data.output_sim, k).shape[0], getattr(data.output_sim, k).shape[1]))&quot;</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">k</span> <span class="o">==</span><span class="s1">&#39;y0&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;y0_m&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;y0_v&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;leadfield&#39;</span><span class="p">):</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot; =  np.zeros((len(pck_files), getattr(data.output_sim, k).shape[1]))&quot;</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">k</span> <span class="o">==</span><span class="s1">&#39;weights&#39;</span><span class="p">):</span>
         <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot; =  np.zeros((len(pck_files), round(np.sqrt(data.output_sim.weights.shape[1]*2)+1), </span><span class="se">\</span>
<span class="s2">                                            round(np.sqrt(data.output_sim.weights.shape[1]*2)+1)))&quot;</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">k</span> <span class="o">==</span><span class="s1">&#39;lm&#39;</span><span class="p">):</span>
         <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot; =  np.zeros((len(pck_files), 62, 200))&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot; =  np.zeros((len(pck_files)))&quot;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sub</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">variable_name</span> <span class="o">=</span> <span class="s1">&#39;all_&#39;</span> <span class="o">+</span> <span class="n">k</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;E_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;E_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Ev_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;Ev_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;I_train&#39;</span>
            <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;I_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Iv_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Iv_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;P_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;P_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Pv_train&#39;</span>
            <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;Pv_test&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;EEG_train&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;EEG_test&#39;</span><span class="p">):</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot;[sub,:,:] =  getattr(data.output_sim, k)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span><span class="s1">&#39;y0&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;y0_m&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;y0_v&#39;</span><span class="p">):</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot;[sub,:] =  getattr(data.output_sim, k)[-1]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;lm&#39;</span><span class="p">):</span>
            <span class="n">lm_mod</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">k</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lm_mod</span> <span class="o">=</span> <span class="n">lm_mod</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">62</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot;[sub,:,:] =  lm_mod&quot;</span><span class="p">)</span>
            <span class="c1">#exec(variable_name + &quot;[sub,:] =  np.mean(getattr(data.output_sim, k)[-10:,:], axis=0)&quot;)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;weights&#39;</span><span class="p">):</span>
            <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sc_mod</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="p">,</span> <span class="n">k</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sc_mod</span> <span class="o">=</span> <span class="n">sc_mod</span><span class="o">+</span><span class="n">sc_mod</span><span class="o">.</span><span class="n">T</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot;[sub,:,:] =  sc_mod&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span><span class="p">):</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot;[sub] =  getattr(data.output_sim, k)[-1]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">exec</span><span class="p">(</span><span class="n">variable_name</span> <span class="o">+</span> <span class="s2">&quot;[sub] = getattr(data.output_sim, k)[-1][0]&quot;</span><span class="p">)</span>


<span class="n">all_params</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
    <span class="n">variable_name</span> <span class="o">=</span> <span class="s1">&#39;all_&#39;</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="n">all_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">variable_name</span><span class="p">]</span>
</pre></div>
</div>
<p>Filter Data for DataFrame</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select specific keys for building a DataFrame and create a DataFrame with those values.</span>

<span class="n">df</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]:</span>
  <span class="n">df</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

<span class="n">sim_eeg</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">sbj2import</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sbj2import</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

  <span class="n">sim_eeg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span><span class="p">)</span>

<span class="n">sim_eeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sim_eeg</span><span class="p">)</span>



<span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">])):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">continue</span>
    <span class="n">new_df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">j</span><span class="p">]]</span>


<span class="nb">print</span><span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">new_df1</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">,</span> <span class="s1">&#39;c4&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;mu&#39;</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
<section id="plot-distributions-of-data-features">
<h3>3.2 Plot Distributions of Data Features<a class="headerlink" href="#plot-distributions-of-data-features" title="Link to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;darkgrid&#39;</span><span class="p">,{</span><span class="s1">&#39;axes.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;.9&#39;</span><span class="p">},)</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;patch.force_edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
  <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">new_df1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">hist_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">),</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">])</span>
  <span class="c1">#sns.displot(new_df1[k], bins=10, ax=ax[row][col])</span>
  <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span>
  <span class="k">if</span> <span class="n">row</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span>

<span class="c1">#f.savefig(&#39;/content/drive/MyDrive/TORONTO/TMS_EEG_model/saving-a-high-resolution-seaborn-plot.png&#39;, dpi=300)</span>
</pre></div>
</div>
<p><strong>Summary of Results:</strong></p>
<p>This plot can be found in Appendix 2—figure 3</p>
<p>Distributions of physiological parameter estimates over subjects.
Histograms and kernel density estimates of the estimated values for the Jansen-Rit model physiological parameters over all subjects. Also shown are prior and posterior parameter values for anatomical connectome weights for a single example subject (bottom right). Parameter estimation was performed using our novel automatic differentiation and gradient-based approach inspired by current techniques in deep learning (Griffiths et al., 2022).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;average synaptic time constant excitatory population (a=1/τe)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s2">&quot;Local gain from pyramidal to excitatory population (C2)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s2">&quot;Global gain (g)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s2">&quot;Average synaptic time constant inhibitory population (b=1/τi)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s2">&quot;Local gain from inhibitory to pyramidal population (C3)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s2">&quot;Local gain from pyramidal to inhibitory population (C4)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s2">&quot;Local gain from excitatory to pyramidal population (C1)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Simulated Empirical and Fitted Structural Connectomes</span>
<span class="n">num_regions</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">empirical_connectome</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>
<span class="n">fitted_connectome</span> <span class="o">=</span> <span class="n">empirical_connectome</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>

<span class="c1"># Emphasize diagonal for better visualization</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">empirical_connectome</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">fitted_connectome</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>

<span class="c1"># Plot Histagram</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;darkgrid&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[:</span><span class="mi">7</span><span class="p">]):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
                 <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Plot Empirical Structural Connectome</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">empirical_connectome</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Empirical Structural Connectome&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Empirical</span><span class="se">\n</span><span class="s2">Structural Connectome&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">),</span>
                    <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">))</span>

<span class="c1"># Plot Fitted Structural Connectome</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">fitted_connectome</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fitted Structural Connectome&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Fitted</span><span class="se">\n</span><span class="s2">Structural Connectome&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">),</span>
                    <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># Final layout and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Parameter Histograms and Structural Connectomes&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Result Description:</strong>
This plot can be found in Appendix 2—figure 3
Distributions of physiological parameter estimates over subjects.
Histograms and kernel density estimates of the estimated values for the Jansen-Rit model physiological parameters over all subjects. Also shown are prior and posterior parameter values for anatomical connectome weights for a single example subject (bottom right). Parameter estimation was performed using our novel automatic differentiation and gradient-based approach inspired by current techniques in deep learning (Griffiths et al., 2022).</p>
</section>
<section id="singular-value-decomposition-svd-of-empirical-and-simulated-eeg">
<h3>3.3 Singular Value Decomposition (SVD) of Empirical and Simulated EEG<a class="headerlink" href="#singular-value-decomposition-svd-of-empirical-and-simulated-eeg" title="Link to this heading">#</a></h3>
<p>Compute SVD for Specific Time Window: Perform SVD on both empirical and simulated EEG data to extract eigenvectors and explained variance.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the default matplotlib style</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

<span class="c1"># Define time range for analysis</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span>  <span class="c1"># Start time (in seconds)</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mf">0.3</span>    <span class="c1"># End time (in seconds)</span>

<span class="c1"># Read epoched EEG data</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

<span class="c1"># Extract data for the specified time range</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">times</span> <span class="o">==</span> <span class="n">xmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">times</span> <span class="o">==</span> <span class="n">xmax</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

<span class="c1"># Perform Singular Value Decomposition (SVD)</span>
<span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">S_PC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>

<span class="c1"># Simulate EEG data in the epochs</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Replace a specific time window with simulated EEG data</span>
<span class="k">for</span> <span class="n">sbj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>  <span class="c1"># Iterate through subjects</span>
    <span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_eeg</span><span class="p">[</span><span class="n">sbj</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Replace data in the defined range</span>

<span class="c1"># Compute average for modified epochs</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

<span class="c1"># Extract data for the same time range from the modified epochs</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">times</span> <span class="o">==</span> <span class="n">xmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">times</span> <span class="o">==</span> <span class="n">xmax</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

<span class="c1"># Perform SVD on the modified data</span>
<span class="n">U_sim</span><span class="p">,</span> <span class="n">S_sim</span><span class="p">,</span> <span class="n">V_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">S_PC_sim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">S_sim</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S_sim</span><span class="p">))</span>  <span class="c1"># Calculate variance explained</span>

<span class="c1"># Create plots for simulated data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Plot topographies of the first five eigenvectors for simulated data</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U_sim</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#1 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC_sim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U_sim</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#2 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC_sim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U_sim</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#3 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC_sim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U_sim</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#4 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC_sim</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U_sim</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#5 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC_sim</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>

<span class="c1"># Create plots for original data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Plot topographies of the first five eigenvectors for original data</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#1 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="o">-</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Flip sign for clarity</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#2 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#3 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#4 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;eigenvector#5 variance explained &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">S_PC</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">_arr1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">_arr2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sc_m</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">_arr3</span> <span class="o">=</span> <span class="n">_arr1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">_arr2</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">_arr1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">_arr2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">_arr3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="compute-and-visualize-similarity-and-visualize-topomaps-for-maximum-similarity">
<h3>3.4 Compute and Visualize Similarity and Visualize Topomaps for Maximum Similarity<a class="headerlink" href="#compute-and-visualize-similarity-and-visualize-topomaps-for-maximum-similarity" title="Link to this heading">#</a></h3>
<p>%%
Compute cosine similarity between eigenvectors and EEG data for specific time windows.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">comp_n</span><span class="o">=</span><span class="mi">0</span>
<span class="n">start_tp</span> <span class="o">=</span> <span class="mi">140</span>
<span class="n">end_tp</span> <span class="o">=</span> <span class="mi">230</span>
<span class="n">ts2use</span> <span class="o">=</span> <span class="s1">&#39;simulated&#39;</span> <span class="c1"># &#39;empirical&#39; or &#39;simulated&#39;</span>


<span class="n">max_similairty</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">sbj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>
  <span class="n">similarity</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_tp</span><span class="p">,</span><span class="n">sim_eeg</span><span class="p">[</span><span class="n">sbj</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">end_tp</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ts2use</span> <span class="o">==</span> <span class="s1">&#39;empirical&#39;</span><span class="p">:</span>
      <span class="n">similarity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cosine</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span> <span class="n">comp_n</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj</span><span class="p">,:,</span><span class="mi">900</span><span class="o">+</span><span class="n">tp</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">similarity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cosine</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">U_sim</span><span class="p">[:,</span> <span class="n">comp_n</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sim_eeg</span><span class="p">[</span><span class="n">sbj</span><span class="p">,:,</span><span class="n">tp</span><span class="p">])))</span>

  <span class="n">similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">similarity</span><span class="p">)</span>
  <span class="n">max_similairty</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">similarity</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">similarity</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


<span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncols</span><span class="o">=</span><span class="mi">3</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>

<span class="n">sbj</span><span class="o">=</span><span class="mi">0</span>

<span class="k">for</span> <span class="n">axes_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">ts2use</span> <span class="o">==</span> <span class="s1">&#39;empirical&#39;</span><span class="p">:</span>
        <span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj</span><span class="p">,:,</span><span class="mi">900</span><span class="o">+</span><span class="n">max_similairty</span><span class="p">[</span><span class="n">sbj</span><span class="p">]</span><span class="o">+</span><span class="n">start_tp</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_row</span><span class="p">,</span><span class="n">ax</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">sim_eeg</span><span class="p">[</span><span class="n">sbj</span><span class="p">,:,</span><span class="n">max_similairty</span><span class="p">[</span><span class="n">sbj</span><span class="p">]</span><span class="o">+</span><span class="n">start_tp</span><span class="p">],</span> <span class="n">epochs</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_row</span><span class="p">,</span><span class="n">ax</span><span class="p">])</span>
      <span class="n">axes</span><span class="p">[</span><span class="n">axes_row</span><span class="p">,</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_similairty</span><span class="p">[</span><span class="n">sbj</span><span class="p">]</span> <span class="o">+</span> <span class="n">start_tp</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;ms after TMS for sbj#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sbj</span><span class="p">))</span>
      <span class="n">sbj</span><span class="o">=</span><span class="n">sbj</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">sbj</span><span class="o">=</span><span class="n">sbj</span>
</pre></div>
</div>
<p><strong>Results description</strong></p>
<p><strong>Timing and topographies of the prototypical TMS-EEG evoked potential (TEP) response pattern in each subject.</strong></p>
<p>This figure can be found in Appendix 2—figure 5 Panel A.</p>
<p>These figures extend the single-subject examples from TEP channel data singular value decompositions (SVD) decompositions in Figure 5.</p>
<p><strong>(A)</strong> First right singular vectors from TEP SVDs for all subjects, with corresponding time location indicating the time point of maximum expression for the corresponding left singular vector (temporal eigenmode).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_similairty</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_tp</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="extract-peaks-from-eeg-data-and-correlate-features-with-peaks">
<h3>3.5 Extract Peaks from EEG Data and Correlate Features with Peaks<a class="headerlink" href="#extract-peaks-from-eeg-data-and-correlate-features-with-peaks" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Analyze the first peaks in EEG signals across multiple subjects, comparing empirical and simulated data.</p></li>
<li><p>Quantify the relationship between these peak properties (latency and amplitude) and external variables (new_df1), likely representing behavioral, experimental, or clinical metrics.</p></li>
</ol>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read epoched EEG data</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>  <span class="c1"># Compute the average of the epochs</span>

<span class="c1"># Convert peak locations from milliseconds to seconds</span>
<span class="n">peaks_locs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_similairty</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1000</span>

<span class="c1"># Initialize lists to store results</span>
<span class="n">first_ch</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c1"># To store the channel of the first peak</span>
<span class="n">fist_peak_locs</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># To store the locations of the first peak</span>
<span class="n">fist_peak_amp</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># To store the amplitudes of the first peak</span>

<span class="c1"># Loop through each subject&#39;s data</span>
<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">peaks_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">sbj2import</span> <span class="o">=</span> <span class="n">xx</span>  <span class="c1"># Current subject index</span>

    <span class="c1"># Create a copy of the evoked data for the current subject</span>
    <span class="n">single_EEG</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">single_EEG</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj2import</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Replace with the subject&#39;s raw EEG data</span>

    <span class="c1"># Simulate EEG data by modifying a specific time window</span>
    <span class="n">simulated_EEG</span> <span class="o">=</span> <span class="n">single_EEG</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">simulated_EEG</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_eeg</span><span class="p">[</span><span class="n">sbj2import</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Replace data in this window with simulated EEG</span>

    <span class="c1"># Find peaks in the EEG data</span>
    <span class="k">if</span> <span class="n">ts2use</span> <span class="o">==</span> <span class="s1">&#39;empirical&#39;</span><span class="p">:</span>  <span class="c1"># Use empirical (original) data</span>
        <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_amp1</span> <span class="o">=</span> <span class="n">single_EEG</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">peaks_locs</span><span class="p">[</span><span class="n">xx</span><span class="p">],</span> <span class="n">tmax</span><span class="o">=</span><span class="n">peaks_locs</span><span class="p">[</span><span class="n">xx</span><span class="p">],</span> <span class="n">return_amplitude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Use simulated data</span>
        <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_amp1</span> <span class="o">=</span> <span class="n">simulated_EEG</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">peaks_locs</span><span class="p">[</span><span class="n">xx</span><span class="p">],</span> <span class="n">tmax</span><span class="o">=</span><span class="n">peaks_locs</span><span class="p">[</span><span class="n">xx</span><span class="p">],</span> <span class="n">return_amplitude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Append results to respective lists</span>
    <span class="n">first_ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="n">fist_peak_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_locs1</span><span class="p">)</span>
    <span class="n">fist_peak_amp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_amp1</span><span class="p">)</span>

<span class="c1"># Convert lists to numpy arrays for easier analysis</span>
<span class="n">first_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">first_ch</span><span class="p">)</span>
<span class="n">fist_peak_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fist_peak_locs</span><span class="p">)</span>
<span class="n">fist_peak_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fist_peak_amp</span><span class="p">)</span>

<span class="c1"># Initialize lists to store correlation results</span>
<span class="n">r_lat</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Correlation coefficients for latency</span>
<span class="n">p_lat</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># P-values for latency</span>
<span class="n">r_amp</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Correlation coefficients for amplitude</span>
<span class="n">p_amp</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># P-values for amplitude</span>

<span class="c1"># Loop through keys in a dataframe or dictionary (new_df1)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="c1"># Correlation between new_df1[j] and first peak locations (latency)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">new_df1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fist_peak_locs</span><span class="p">)</span>
    <span class="n">r_lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p_lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># Correlation between new_df1[j] and first peak amplitudes</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">new_df1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fist_peak_amp</span><span class="p">)</span>
    <span class="n">r_amp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p_amp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="c1"># Convert correlation results to numpy arrays</span>
<span class="n">r_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_lat</span><span class="p">)</span>
<span class="n">p_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_lat</span><span class="p">)</span>
<span class="n">r_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_amp</span><span class="p">)</span>
<span class="n">p_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_amp</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_amp</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_lat</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">))</span>
</pre></div>
</div>
<p>Visualize the results</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the relationship between the first EEG peak&#39;s amplitude or latency and a variable of interest from new_df1.</span>
<span class="c1"># Optionally exclude outliers to ensure robust analysis.</span>
<span class="c1"># Provide statistical insight into the relationship through R² and p-values.</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Settings for plotting and analysis</span>
<span class="n">key2plot</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">exclude_outliers</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">std_from_mean</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">variable2plot</span> <span class="o">=</span> <span class="s1">&#39;amplitude&#39;</span>  <span class="c1"># Choose &#39;amplitude&#39; or &#39;latency&#39; for the analysis</span>

<span class="c1"># Select data to plot based on the variable of interest</span>
<span class="k">if</span> <span class="n">variable2plot</span> <span class="o">==</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">:</span>
    <span class="n">data2plot</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;amp_all&#39;</span><span class="p">:</span> <span class="n">fist_peak_amp</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]:</span> <span class="n">new_df1</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]}</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">data2plot</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat_all&#39;</span><span class="p">:</span> <span class="n">fist_peak_locs</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]:</span> <span class="n">new_df1</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]}</span>

<span class="c1"># Create a DataFrame from the selected data</span>
<span class="n">df2plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data2plot</span><span class="p">)</span>

<span class="c1"># Initialize a list to store indices of outliers</span>
<span class="n">outlier</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Identify outliers in the data (if enabled)</span>
<span class="k">if</span> <span class="n">exclude_outliers</span><span class="p">:</span>
    <span class="c1"># Calculate upper and lower bounds for outliers in the first variable</span>
    <span class="n">std_up</span> <span class="o">=</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">std_from_mean</span> <span class="o">*</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="n">std_down</span> <span class="o">=</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">std_from_mean</span> <span class="o">*</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

    <span class="c1"># Check for outliers above the upper bound</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">std_up</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outlier</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">std_up</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Check for outliers below the lower bound</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">std_down</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outlier</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">std_down</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Calculate upper and lower bounds for outliers in the second variable</span>
<span class="n">std_up</span> <span class="o">=</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">std_from_mean</span> <span class="o">*</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">std_down</span> <span class="o">=</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">std_from_mean</span> <span class="o">*</span> <span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="k">if</span> <span class="n">exclude_outliers</span><span class="p">:</span>
    <span class="c1"># Check for outliers below the lower bound</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">std_down</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outlier</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">std_down</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Check for outliers above the upper bound</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">std_up</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outlier</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">std_up</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Remove identified outliers from the DataFrame</span>
<span class="n">df2plot</span> <span class="o">=</span> <span class="n">df2plot</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">outlier</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;outliers=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">outlier</span><span class="p">))</span>  <span class="c1"># Print the indices of the outliers</span>

<span class="c1"># Create a scatter plot with a linear regression line</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">new_df1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">key2plot</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data2plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df2plot</span><span class="p">)</span>

<span class="c1"># Add a title to the plot, including R^2 and p-values</span>
<span class="k">if</span> <span class="n">variable2plot</span> <span class="o">==</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Amplitude R^2=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">r_amp</span><span class="p">[</span><span class="n">key2plot</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;  p=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p_amp</span><span class="p">[</span><span class="n">key2plot</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Latency R^2=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">r_lat</span><span class="p">[</span><span class="n">key2plot</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;  p=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p_lat</span><span class="p">[</span><span class="n">key2plot</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
<p><strong>Result Description:</strong>
This figure could be found at Appendix 2—figure 10.
<strong>Structural connectivity predictor of TMS-EEG propagation.</strong>
A significant positive correlation (R2=52%, p=0.02) was found between the modularity of the fitted structural connectomes and the area under the curve (AUC) extracted for significant post-TMS time points. This findings replicate the results reported in Momi et al., 2021b.</p>
</section>
</section>
<section id="model-vs-data-comparisons-and-visualizations">
<h2>4 - Model vs. data comparisons and visualizations<a class="headerlink" href="#model-vs-data-comparisons-and-visualizations" title="Link to this heading">#</a></h2>
<p>get ready</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1">#files_dir =  &#39;/external/rprshnas01/netdata_kcni/jglab/Data/Davide/reproduce_Momi_et_al_2022/PyTepFit/data&#39;</span>

<span class="n">pck_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/*_fittingresults_stim_exp.pkl&#39;</span><span class="p">))</span>
<span class="c1"># pck_files.pop()</span>
<span class="n">pck_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">var</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^0-9]|[0-9]+&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">)])</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">keys</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<section id="draw-the-plot-for-each-subject">
<h3>4.1 Draw the plot for each subject<a class="headerlink" href="#draw-the-plot-for-each-subject" title="Link to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">num_subjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sbj2plot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_subjects</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing Subject: </span><span class="si">{</span><span class="n">sbj2plot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">empirical_data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
    <span class="n">empirical_data</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj2plot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># subject-specific data</span>

    <span class="c1"># Subject-specific peak detection from their own data</span>
    <span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">empirical_data</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">empirical_data</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">empirical_data</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">empirical_data</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>

    <span class="n">empirical_data</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Empirical TEPs for sub </span><span class="si">{</span><span class="n">sbj2plot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sbj2plot</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">simulated_data</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
    <span class="n">simulated_data</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span>

    <span class="n">simulated_data</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Simulated TEPs for sub </span><span class="si">{</span><span class="n">sbj2plot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject </span><span class="si">{</span><span class="n">sbj2plot</span><span class="si">}</span><span class="s2"> processed successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>Result Description: **</p>
<p>Empirical and Simulated TEPs figure for all subjects. Optimized TMS-EEG evoked potential (TEP) models for all subjects.</p>
<p>For every pair of rows, empirical (upper) and simulated (lower) TMS-EEG responses are shown for every study subject, extending main text Figure 2 where a selected subset of subjects’ data are shown. These data reiterate and reinforce the demonstrations in Figure 2 that the model-generated electroencephalography (EEG) activity time series achieve robust recovery of individual subjects’ empirical TEP propagation patterns.</p>
<p>This is the Appendix 2—figure 1 plot.</p>
<p>Load Experimental and Simulated EEG Data</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">spatial</span>

<span class="n">only_high_trial</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/only_high_trial.mat&#39;</span><span class="p">)[</span><span class="s1">&#39;only_high_trial&#39;</span><span class="p">]</span>
<span class="n">all_sim_EEG</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_sim_parcels</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">sbj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>

  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sbj</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="n">all_sim_EEG</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span><span class="p">)</span>
  <span class="n">all_sim_parcels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">E_test</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">I_test</span><span class="p">)</span>

<span class="n">all_sim_EEG</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_sim_EEG</span><span class="p">)</span> <span class="c1"># JG_ADD</span>
<span class="n">all_sim_parcels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_sim_parcels</span><span class="p">)</span>
</pre></div>
</div>
<p>Append Simulated EEG and Parcel Data and Aggregate Permutation Results</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">shuffle</span>

<span class="c1"># Parameters for permutation testing</span>
<span class="n">nPerms</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of permutations</span>
<span class="n">pval</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># p-value threshold</span>
<span class="n">sigThresh</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pval</span><span class="p">)</span>  <span class="c1"># Two-tailed significance threshold (z-score)</span>

<span class="c1"># Initialize similarity and correlation matrices</span>
<span class="n">similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">corr_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Correlation coefficients</span>
<span class="n">corr_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># p-values for correlations</span>

<span class="c1"># Loop through each subject</span>
<span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>  <span class="c1"># Modify range as needed based on data shape</span>
    <span class="n">evoked_T0</span> <span class="o">=</span> <span class="n">only_high_trial</span><span class="p">[</span><span class="n">subj</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span>  <span class="c1"># Extract original EEG signal in a specific window</span>
    <span class="n">evoked_T2</span> <span class="o">=</span> <span class="n">all_sim_EEG</span><span class="p">[</span><span class="n">subj</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Extract simulated EEG signal</span>

    <span class="c1"># Loop through each channel</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evoked_T2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">electrode_T0</span> <span class="o">=</span> <span class="n">evoked_T0</span><span class="p">[</span><span class="n">channel</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Original EEG signal for a channel</span>
        <span class="n">electrode_T2</span> <span class="o">=</span> <span class="n">evoked_T2</span><span class="p">[</span><span class="n">channel</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Simulated EEG signal for the same channel</span>

        <span class="c1"># Normalize the signals</span>
        <span class="n">electrode_T0</span> <span class="o">=</span> <span class="p">(</span><span class="n">electrode_T0</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">))</span>
        <span class="n">electrode_T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">electrode_T2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">electrode_T2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T2</span><span class="p">))</span>

        <span class="c1"># Compute cosine similarity and Pearson correlation</span>
        <span class="n">similarity</span><span class="p">[</span><span class="n">subj</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cosine</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">,</span> <span class="n">electrode_T2</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">,</span> <span class="n">electrode_T2</span><span class="p">)</span>
        <span class="n">corr_r</span><span class="p">[</span><span class="n">subj</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>  <span class="c1"># Store correlation coefficient</span>
        <span class="n">corr_p</span><span class="p">[</span><span class="n">subj</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>  <span class="c1"># Store p-value</span>

<span class="c1"># Process similarity results</span>
<span class="n">similarity_corr</span> <span class="o">=</span> <span class="n">similarity</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">similarity_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">similarity_corr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">similarity_corr</span><span class="p">)</span>  <span class="c1"># Clip values between 0 and 1</span>
<span class="n">zthresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">similarity_corr</span><span class="p">))</span>  <span class="c1"># Compute z-scores</span>
<span class="n">zthresh</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zthresh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sigThresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Apply significance threshold</span>
<span class="n">zthresh_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">zthresh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Compute average z-scores</span>

<span class="c1"># Process p-values</span>
<span class="n">corr_p_sign</span> <span class="o">=</span> <span class="n">corr_p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">corr_p_sign_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_p_sign</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Average p-values across subjects</span>
<span class="n">corr_p_sign_avg</span><span class="p">[</span><span class="n">corr_p_sign_avg</span> <span class="o">&gt;</span> <span class="n">pval</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Retain significant p-values only</span>

<span class="c1"># Initialize matrices for permutation testing</span>
<span class="n">fake_similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nPerms</span><span class="p">,</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">fake_corr_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nPerms</span><span class="p">,</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">fake_corr_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nPerms</span><span class="p">,</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">only_high_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Permutation testing</span>
<span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPerms</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>  <span class="c1"># Modify range as needed</span>
        <span class="n">evoked_T0</span> <span class="o">=</span> <span class="n">only_high_trial</span><span class="p">[</span><span class="n">subj</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span>  <span class="c1"># Original EEG signal</span>
        <span class="n">evoked_T2</span> <span class="o">=</span> <span class="n">all_sim_EEG</span><span class="p">[</span><span class="n">subj</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Simulated EEG signal</span>

        <span class="c1"># Loop through each channel</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evoked_T2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">electrode_T0</span> <span class="o">=</span> <span class="n">evoked_T0</span><span class="p">[</span><span class="n">channel</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Original EEG signal for a channel</span>
            <span class="n">ind_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">electrode_T2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">shuffle</span><span class="p">(</span><span class="n">ind_list</span><span class="p">)</span>  <span class="c1"># Shuffle indices</span>
            <span class="n">electrode_T0</span> <span class="o">=</span> <span class="n">electrode_T0</span><span class="p">[</span><span class="n">ind_list</span><span class="p">]</span>  <span class="c1"># Randomize signal</span>

            <span class="n">electrode_T2</span> <span class="o">=</span> <span class="n">evoked_T2</span><span class="p">[</span><span class="n">channel</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Simulated EEG signal</span>
            <span class="n">shuffle</span><span class="p">(</span><span class="n">ind_list</span><span class="p">)</span>  <span class="c1"># Shuffle indices again</span>
            <span class="n">electrode_T2</span> <span class="o">=</span> <span class="n">electrode_T2</span><span class="p">[</span><span class="n">ind_list</span><span class="p">]</span>  <span class="c1"># Randomize signal</span>

            <span class="c1"># Normalize the signals</span>
            <span class="n">electrode_T0</span> <span class="o">=</span> <span class="p">(</span><span class="n">electrode_T0</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">))</span>
            <span class="n">electrode_T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">electrode_T2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">electrode_T2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">electrode_T2</span><span class="p">))</span>

            <span class="c1"># Compute similarity and correlation for shuffled data</span>
            <span class="n">fake_similarity</span><span class="p">[</span><span class="n">perm</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cosine</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">,</span> <span class="n">electrode_T2</span><span class="p">)</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">electrode_T0</span><span class="p">,</span> <span class="n">electrode_T2</span><span class="p">)</span>
            <span class="n">fake_corr_r</span><span class="p">[</span><span class="n">perm</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">fake_corr_p</span><span class="p">[</span><span class="n">perm</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

<span class="c1"># Process permutation test results</span>
<span class="n">fake_similarity_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fake_similarity</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">fake_zthresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">fake_similarity_avg</span><span class="p">))</span>  <span class="c1"># Compute z-scores</span>
<span class="n">fake_zthresh</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fake_zthresh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sigThresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Apply significance threshold</span>
<span class="n">fake_zthresh_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fake_zthresh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">fake_corr_p_sign</span> <span class="o">=</span> <span class="n">fake_corr_p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">fake_corr_p_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fake_corr_p_sign</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Average p-values across permutations</span>
<span class="n">fake_corr_p_avg</span><span class="p">[</span><span class="n">fake_corr_p_avg</span> <span class="o">&gt;</span> <span class="n">pval</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Retain significant p-values only</span>
</pre></div>
</div>
</section>
<section id="visualize-correlation-results">
<h3>4.2 Visualize Correlation Results<a class="headerlink" href="#visualize-correlation-results" title="Link to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">x_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">corr_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">barlist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>


<span class="n">color_map</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
  <span class="n">rgba</span> <span class="o">=</span> <span class="n">color_map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">xx</span><span class="p">])</span>
  <span class="n">barlist</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">([</span><span class="n">rgba</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rgba</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rgba</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
</pre></div>
</div>
<p><strong>Comparison between simulated and empirical TMS-EEG data in source space.</strong>
Bar plot showing high vertex-wise cosine similarity between empirical and simulated sources for all the subjects.
This plot can be found in Figure 3 Panel E</p>
<p>Creating function for calculating PCI</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

<span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;baseline_window&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="s1">&#39;response_window&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="mf">1.2</span><span class="p">,</span> <span class="s1">&#39;min_snr&#39;</span><span class="p">:</span><span class="mf">1.1</span><span class="p">,</span>
        <span class="s1">&#39;max_var&#39;</span><span class="p">:</span><span class="mi">99</span><span class="p">,</span> <span class="s1">&#39;embed&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;n_steps&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span>

<span class="n">PCI_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)))</span>
<span class="n">PCI_emp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">sbj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)):</span>
  <span class="n">PCI_emp</span><span class="p">[</span><span class="n">sbj</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_PCIst</span><span class="p">(</span><span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">sbj</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">evoked</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="o">**</span><span class="n">par</span><span class="p">,</span> <span class="n">full_return</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pck_files</span><span class="p">[</span><span class="n">sbj</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">simulated_EEG_st</span><span class="o">=</span><span class="n">evoked</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">simulated_EEG_st</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">output_sim</span><span class="o">.</span><span class="n">eeg_test</span>
    <span class="n">PCI_sim</span><span class="p">[</span><span class="n">sbj</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_PCIst</span><span class="p">(</span><span class="n">simulated_EEG_st</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">evoked</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="o">**</span><span class="n">par</span><span class="p">,</span> <span class="n">full_return</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="visualization-of-comparison-between-simulated-and-empirical-tms-eeg-data-in-channel-space">
<h3>4.3 Visualization of Comparison between simulated and empirical TMS-EEG data in channel space.<a class="headerlink" href="#visualization-of-comparison-between-simulated-and-empirical-tms-eeg-data-in-channel-space" title="Link to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">x_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">corr_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

<span class="n">data2plot</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">&quot;PCI_sim&quot;</span><span class="p">:</span> <span class="n">PCI_sim</span><span class="p">,</span>
          <span class="s2">&quot;PCI_emp&quot;</span><span class="p">:</span> <span class="n">PCI_emp</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">bp_1</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data2plot</span><span class="p">,</span> <span class="n">total_width</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">single_width</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">df2plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">PCI_sim</span><span class="p">,</span> <span class="n">PCI_emp</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PCI_sim&#39;</span><span class="p">,</span> <span class="s1">&#39;PCI_emp&#39;</span><span class="p">])</span>

<span class="n">scatter</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;PCI_sim&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;PCI_emp&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df2plot</span><span class="p">);</span>
<span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">df2plot</span><span class="p">[</span><span class="s1">&#39;PCI_sim&#39;</span><span class="p">],</span> <span class="n">df2plot</span><span class="p">[</span><span class="s1">&#39;PCI_emp&#39;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;R2=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; p=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
<p><strong>Those two plots above can be found in Figure 2 Panel D</strong>
Comparison between simulated and empirical TMS-EEG data in channel space.</p>
<blockquote>
<div><p>Perturbational complexity index (PCI) values extracted from the empirical (orange) and simulated (blue) TMS-EEG time series (left). A significant positive correlation (R2=80%, p&lt;0.001) was found between the simulated and the empirical PCI (right), demonstrating high correspondence between empirical and simulated data.</p>
</div></blockquote>
</section>
<section id="comparison-between-simulated-and-empirical-tms-eeg-data-in-source-space">
<h3>4.4 Comparison between simulated and empirical TMS-EEG data in source space.<a class="headerlink" href="#comparison-between-simulated-and-empirical-tms-eeg-data-in-source-space" title="Link to this heading">#</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">x_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">corr_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="n">files_dir</span> <span class="o">+</span> <span class="s1">&#39;/all_avg.mat_avg_high_epoched&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>


<span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.3</span><span class="p">])</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.07</span><span class="p">)</span>
<span class="c1">#ch, peak_locs3 = evoked.get_peak(ch_type=&#39;eeg&#39;, tmin=0.1, tmax=0.12)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>

<span class="n">evoked</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Empirical Grand Mean&#39;</span><span class="p">);</span>


<span class="n">epochs</span><span class="o">.</span><span class="n">_data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">),:,</span><span class="mi">900</span><span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_sim_EEG</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">pck_files</span><span class="p">)]</span>

<span class="n">sim_evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>


<span class="n">ts_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.3</span><span class="p">])</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs1</span> <span class="o">=</span> <span class="n">sim_evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs2</span> <span class="o">=</span> <span class="n">sim_evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.07</span><span class="p">)</span>
<span class="c1">#ch, peak_locs3 = evoked.get_peak(ch_type=&#39;eeg&#39;, tmin=0.1, tmax=0.12)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs4</span> <span class="o">=</span> <span class="n">sim_evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">ch</span><span class="p">,</span> <span class="n">peak_locs5</span> <span class="o">=</span> <span class="n">sim_evoked</span><span class="o">.</span><span class="n">get_peak</span><span class="p">(</span><span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_locs1</span><span class="p">,</span> <span class="n">peak_locs2</span><span class="p">,</span> <span class="n">peak_locs4</span><span class="p">,</span> <span class="n">peak_locs5</span><span class="p">]</span>

<span class="n">sim_evoked</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">ts_args</span><span class="o">=</span><span class="n">ts_args</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Simulated Grand Mean&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><a href="#id3"><span class="problematic" id="id4">**</span></a>Result Discription: **
TMS-EEG time series showing a robust recovery of grand-mean empirical TMS-EEG evoked potential (TEP) patterns in model-generated electroencephalography (EEG) time series</p>
<p>This plot could be found as Panel A in Figure 3.</p>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<p>Momi, D., Wang, Z., Griffiths, J.D. (2023). “TMS-evoked responses are driven by recurrent large-scale network dynamics.” eLife, 10.7554/eLife.83232. <a class="reference external" href="https://doi.org/10.7554/eLife.83232">https://doi.org/10.7554/eLife.83232</a></p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-eg-momi2023-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/c0aa0ed03c2583762d5d6226381b960b/eg__momi2023.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">eg__momi2023.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/8592f14304a6c6b34d2df2ac26c242d4/eg__momi2023.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">eg__momi2023.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/e59830dda392e4239ea4609ee6b8e8cf/eg__momi2023.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">eg__momi2023.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


  
</div>

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-of-study-and-summary-of-key-results">0. Overview of study and summary of key results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#study-overview">Study Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conceptual-framework">Conceptual Framework</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#large-scale-neurophysiological-brain-network-model">Large-scale neurophysiological brain network model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-results">Main Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#list-of-analyses-and-figures">List of analyses and figures</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">1. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-fitting-and-key-results">2 - Model fitting and key results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-data">2.1 Load the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-example-trials-and-stimulated-data">2.2 Plotting Example Trials and Stimulated Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-structural-connectivity-and-stimulation-weights">2.3 Visualize Structural Connectivity and Stimulation Weights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-setup-and-training">2.4 Model Setup and Training</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-model-parameters">3 - Exploring model parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-distributions-of-data-features">3.2 Plot Distributions of Data Features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#singular-value-decomposition-svd-of-empirical-and-simulated-eeg">3.3 Singular Value Decomposition (SVD) of Empirical and Simulated EEG</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-and-visualize-similarity-and-visualize-topomaps-for-maximum-similarity">3.4 Compute and Visualize Similarity and Visualize Topomaps for Maximum Similarity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-peaks-from-eeg-data-and-correlate-features-with-peaks">3.5 Extract Peaks from EEG Data and Correlate Features with Peaks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-vs-data-comparisons-and-visualizations">4 - Model vs. data comparisons and visualizations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#draw-the-plot-for-each-subject">4.1 Draw the plot for each subject</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-correlation-results">4.2 Visualize Correlation Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-of-comparison-between-simulated-and-empirical-tms-eeg-data-in-channel-space">4.3 Visualization of Comparison between simulated and empirical TMS-EEG data in channel space.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-between-simulated-and-empirical-tms-eeg-data-in-source-space">4.4 Comparison between simulated and empirical TMS-EEG data in source space.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

    <script src="https://mne.tools/versionwarning.js"></script>
  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><p class="text-center small">&copy; Copyright </p></div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>